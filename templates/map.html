<!-- templates/map.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nav Tracker</title>

<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Arial; }
#map { height:100%; width:100%; }

/* Panel */
#panel {
  position:absolute;
  top:12px;
  right:12px;
  width:340px;
  max-height:calc(100% - 24px);
  overflow:auto;
  background:rgba(255,255,255,0.96);
  border-radius:14px;
  padding:14px;
  box-shadow:0 12px 30px rgba(0,0,0,.15);
  z-index:999;
  transition:all .25s ease;
}

#panel h3 { margin:0 0 6px 0; }
.small { font-size:12px; color:#555; }

.dot {
  width:10px;height:10px;border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 6px rgba(0,0,0,.3);
}

.event {
  border-top:1px solid rgba(0,0,0,.08);
  padding:10px 0;
}

button {
  border:1px solid rgba(0,0,0,.2);
  background:#fff;
  border-radius:999px;
  padding:6px 12px;
  cursor:pointer;
}

/* MOBILE */
@media (max-width:768px) {
  #panel {
    left:12px;
    right:12px;
    top:auto;
    bottom:12px;
    width:auto;
    max-height:50vh;
  }

  #panel.collapsed {
    max-height:60px;
    overflow:hidden;
  }
}
</style>
</head>

<body>
<div id="map"></div>

<div id="panel">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3>Events</h3>
    <button id="togglePanel">Hide</button>
  </div>

  <div class="small">Auto-refresh every 3s</div>
  <div id="status" class="small" style="margin-top:6px;">Loading…</div>

  <div id="events"></div>
</div>

<script>
// =====================
// Unique colours
// =====================
const PALETTE = [
  "#e6194B","#3cb44b","#4363d8","#f58231","#911eb4",
  "#46f0f0","#f032e6","#bcf60c","#fabebe","#008080",
  "#e6beff","#9A6324","#fffac8","#800000","#aaffc3",
  "#808000","#ffd8b1","#000075","#808080","#ff7f50"
];

function hashUser(u){
  let h=0;
  for(let i=0;i<u.length;i++){
    h=((h<<5)-h)+u.charCodeAt(i);
    h|=0;
  }
  return Math.abs(h);
}

function colorForUser(u){
  return PALETTE[ hashUser(u||"") % PALETTE.length ];
}

function colorDotIcon(color){
  return L.divIcon({
    className:"",
    html:`<div style="
      width:14px;height:14px;border-radius:50%;
      background:${color};
      border:2px solid white;
      box-shadow:0 0 6px rgba(0,0,0,.35);
    "></div>`,
    iconSize:[14,14],
    iconAnchor:[7,7]
  });
}

// =====================
// Map
// =====================
const map = L.map('map').setView([1.3521,103.8198],12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'© OpenStreetMap'
}).addTo(map);

const markers = {};

// =====================
// Fetch + Refresh
// =====================
async function fetchJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(r.status);
  return await r.json();
}

function setStatus(msg, ok=true){
  const el=document.getElementById("status");
  el.textContent=msg;
  el.style.color= ok ? "#006400" : "#b00020";
}

function renderEvents(items){
  const box=document.getElementById("events");
  box.innerHTML="";

  if(!items.length){
    box.innerHTML="<div class='event'>No events yet.</div>";
    return;
  }

  items.forEach(e=>{
    const c=colorForUser(e.user);
    const div=document.createElement("div");
    div.className="event";
    div.innerHTML=`
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="dot" style="background:${c}"></div>
        <b>${e.user}</b>
      </div>
      <div class="small" style="margin-top:4px;">
        ${e.ts}<br/>
        lat ${Number(e.lat).toFixed(6)}, lng ${Number(e.lng).toFixed(6)}
      </div>
    `;
    box.appendChild(div);
  });
}

async function refresh(){
  try{
    const positions = await fetchJSON("/positions?since_sec=3600");

    // Update markers
    const seen=new Set();

    positions.forEach(p=>{
      if(p.lat==null||p.lng==null) return;
      seen.add(p.user);
      const c=colorForUser(p.user);

      if(!markers[p.user]){
        markers[p.user]=L.marker([p.lat,p.lng],{
          icon:colorDotIcon(c)
        }).addTo(map)
        .bindPopup(`<b>${p.user}</b><br/>${p.ts}`);
      } else {
        markers[p.user].setLatLng([p.lat,p.lng]);
        markers[p.user].setIcon(colorDotIcon(c));
      }
    });

    // remove old markers
    Object.keys(markers).forEach(u=>{
      if(!seen.has(u)){
        map.removeLayer(markers[u]);
        delete markers[u];
      }
    });

    const events = await fetchJSON("/events?limit=20");
    renderEvents(events);

    setStatus(`OK (${positions.length} users)`);

  } catch(e){
    setStatus("Refresh failed",false);
  }
}

refresh();
setInterval(refresh,3000);

// =====================
// Collapsible panel
// =====================
const toggleBtn=document.getElementById("togglePanel");
const panel=document.getElementById("panel");

toggleBtn.addEventListener("click",()=>{
  panel.classList.toggle("collapsed");
  toggleBtn.textContent = panel.classList.contains("collapsed")
    ? "Show"
    : "Hide";
});
</script>

</body>
</html>