<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phone GPS Sender</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; padding: 18px; line-height: 1.35; }
    h1 { margin: 0 0 14px 0; }
    .row { margin: 10px 0; }
    label { display:block; font-weight: 650; margin-bottom: 6px; }
    input { width: 100%; max-width: 420px; padding: 10px; font-size: 16px; }
    button { padding: 12px 16px; font-size: 16px; margin-right: 10px; }
    .status { margin-top: 14px; padding: 10px; background: #f5f5f5; border-radius: 8px; max-width: 520px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hint { color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Phone GPS Sender</h1>

  <div class="row">
    <label>User</label>
    <input id="user" placeholder="e.g., Ben" />
    <div class="hint">This name is what appears on the map/events.</div>
  </div>

  <div class="row">
    <label>Token</label>
    <input id="token" placeholder="e.g., OPS2026" />
    <div class="hint">Must match server TOKEN (default: OPS2026).</div>
  </div>

  <div class="row">
    <button id="startBtn">Start Sending</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div class="status">
    <div><b>Sending:</b> <span id="sendState">No</span></div>
    <div class="mono" id="lastLine">—</div>
    <div class="hint">Keep this tab open. iOS may pause GPS if Safari goes background or screen locks.</div>
  </div>

<script>
  // Read query string: /sender?user=Ben&token=OPS2026
  const qs = new URLSearchParams(window.location.search);
  const userEl = document.getElementById("user");
  const tokenEl = document.getElementById("token");
  const sendStateEl = document.getElementById("sendState");
  const lastLineEl = document.getElementById("lastLine");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");

  userEl.value = qs.get("user") || "";
  tokenEl.value = qs.get("token") || "";

  let watchId = null;
  let timerId = null;
  let latestPos = null;

  function setSending(isOn) {
    sendStateEl.textContent = isOn ? "Yes" : "No";
    startBtn.disabled = isOn;
    stopBtn.disabled = !isOn;
  }

  async function postEvent(pos) {
    const payload = {
      user: (userEl.value || "anonymous").trim(),
      token: (tokenEl.value || "").trim(),
      event: "ping",
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      acc: pos.coords.accuracy
    };

    const res = await fetch("/event", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(`POST /event failed (${res.status}): ${t}`);
    }
  }

  function formatLine(pos) {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    const acc = Math.round(pos.coords.accuracy);
    return `Sending: ${lat}, ${lng} (±${acc}m)`;
  }

  function onPos(pos) {
    latestPos = pos;
    lastLineEl.textContent = formatLine(pos);
  }

  function onErr(err) {
    lastLineEl.textContent = `GPS error: ${err.message || err}`;
  }

  async function tickSend() {
    if (!latestPos) {
      lastLineEl.textContent = "Waiting for GPS fix…";
      return;
    }
    try {
      await postEvent(latestPos);
    } catch (e) {
      lastLineEl.textContent = String(e);
    }
  }

  startBtn.addEventListener("click", async () => {
    if (!navigator.geolocation) {
      lastLineEl.textContent = "Geolocation not supported on this device/browser.";
      return;
    }

    // Prompt permission immediately
    watchId = navigator.geolocation.watchPosition(onPos, onErr, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 15000
    });

    // Send every 3 seconds
    timerId = setInterval(tickSend, 3000);

    setSending(true);
    lastLineEl.textContent = "Starting… if prompted, tap Allow location.";
  });

  stopBtn.addEventListener("click", () => {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    if (timerId !== null) clearInterval(timerId);
    watchId = null;
    timerId = null;
    latestPos = null;
    setSending(false);
    lastLineEl.textContent = "Stopped.";
  });
</script>
</body>
</html>