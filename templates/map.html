<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nav Tracker Map</title>

  <!-- Leaflet (MUST be https) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; } /* critical for "blank map" issues */

    #panel {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 10px;
      width: 260px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }

    #panel h3 { margin: 0 0 8px 0; font-size: 14px; }
    #row { display: flex; gap: 6px; align-items: center; }
    #username {
      flex: 1;
      padding: 7px 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
    }
    button {
      padding: 7px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #f6f6f6; }

    .meta { font-size: 12px; margin-top: 8px; color: #222; }
    .muted { color: #666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .links { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
    .links a { font-size: 12px; text-decoration: none; }
    .pill {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      display: inline-block;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="panel">
    <h3>Nav Tracker</h3>

    <div id="row">
      <input id="username" placeholder="Enter your name" />
      <button id="setNameBtn" type="button">Set</button>
    </div>

    <div class="meta">
      <div>Current name: <span id="currentName" class="mono">...</span></div>
      <div class="muted">Auto-refresh: every 3s</div>
      <div id="status" class="meta muted">Starting…</div>
      <div id="gps" class="meta muted"></div>
      <div id="lastSent" class="meta muted"></div>
    </div>

    <div class="links">
      <a class="pill" href="/events?limit=30" target="_blank" rel="noreferrer">Events (latest 30)</a>
      <a class="pill" href="/map" target="_blank" rel="noreferrer">Open Map</a>
    </div>
  </div>

  <script>
    // ========== Helpers ==========
    function qs(name) {
      const v = new URLSearchParams(window.location.search).get(name);
      return v ? v.trim() : "";
    }

    function safeName(raw) {
      // keep it simple; avoid empty, crazy long names
      const cleaned = (raw || "").trim().slice(0, 24);
      return cleaned.replace(/[^\w\s\-\.]/g, ""); // letters/numbers/_ space - .
    }

    function randomTesterName() {
      const n = Math.floor(1000 + Math.random() * 9000);
      return `tester-${n}`;
    }

    function nowStr() {
      const d = new Date();
      return d.toLocaleString();
    }

    // ========== Name logic ==========
    // Priority: URL ?user= -> localStorage -> auto-generated
    const LS_KEY = "nav_tracker_user";

    let userFromUrl = safeName(qs("user"));
    let userFromLS = safeName(localStorage.getItem(LS_KEY));
    let currentUser = userFromUrl || userFromLS || randomTesterName();

    // Put into UI + persist
    const usernameInput = document.getElementById("username");
    const currentNameEl = document.getElementById("currentName");
    const statusEl = document.getElementById("status");
    const gpsEl = document.getElementById("gps");
    const lastSentEl = document.getElementById("lastSent");

    function applyUser(newName) {
      const name = safeName(newName);
      if (!name) return;
      currentUser = name;
      localStorage.setItem(LS_KEY, currentUser);
      usernameInput.value = currentUser;
      currentNameEl.textContent = currentUser;
    }

    applyUser(currentUser);

    document.getElementById("setNameBtn").addEventListener("click", () => {
      applyUser(usernameInput.value);
      statusEl.textContent = `Name saved as "${currentUser}"`;
    });

    // If user came via ?user=, save it so they don't need to type next time
    if (userFromUrl) {
      localStorage.setItem(LS_KEY, currentUser);
    }

    // ========== Leaflet Map ==========
    const map = L.map("map").setView([1.3521, 103.8198], 11); // SG
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // user -> marker
    const markers = {};

    async function refreshMarkers() {
      try {
        const res = await fetch("/positions", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!Array.isArray(data)) throw new Error("positions is not an array");

        // Status line
        if (data.length === 0) {
          statusEl.textContent = "No devices yet.";
        } else {
          const names = data.map(d => d.user).filter(Boolean);
          statusEl.textContent = `Tracking (${data.length}): ${names.join(", ")}`;
        }

        for (const p of data) {
          if (!p || typeof p.lat !== "number" || typeof p.lon !== "number") continue;

          const name = (p.user || "unknown").toString();
          const latlng = [p.lat, p.lon];

          if (!markers[name]) {
            markers[name] = L.marker(latlng).addTo(map).bindPopup(name);
          } else {
            markers[name].setLatLng(latlng);
          }
        }
      } catch (e) {
        statusEl.textContent = "Refresh failed (check server).";
      }
    }

    // ========== GPS -> backend ==========
    // Throttle sending so we don't spam the server every tiny movement
    let lastSendMs = 0;
    const MIN_SEND_INTERVAL_MS = 2500;

    async function sendPing(lat, lng, acc) {
      const now = Date.now();
      if (now - lastSendMs < MIN_SEND_INTERVAL_MS) return;
      lastSendMs = now;

      try {
        await fetch("/event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user: currentUser,
            event: "ping",
            lat: lat,
            lng: lng,
            acc: acc
          })
        });
        lastSentEl.textContent = `Last sent: ${nowStr()}`;
      } catch (e) {
        lastSentEl.textContent = `Last sent: failed (${nowStr()})`;
      }
    }

    function startGeolocation() {
      if (!("geolocation" in navigator)) {
        gpsEl.textContent = "GPS: not supported on this device/browser.";
        return;
      }

      gpsEl.textContent = "GPS: requesting permission…";

      navigator.geolocation.watchPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const acc = position.coords.accuracy;

          gpsEl.textContent = `GPS: ok (±${Math.round(acc)}m)`;
          sendPing(lat, lng, acc);
        },
        (error) => {
          gpsEl.textContent = `GPS error: ${error.message || error.code}`;
        },
        {
          enableHighAccuracy: true,
          maximumAge: 2000,
          timeout: 15000
        }
      );
    }

    // ========== Kickoff ==========
    refreshMarkers();
    setInterval(refreshMarkers, 3000);
    startGeolocation();
  </script>
</body>
</html>