<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- IMPORTANT for mobile sizing -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Nav Tracker</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    /* Layout: map + events */
    .app {
      height: 100%;
      display: flex;
      flex-direction: row;
    }
    #map {
      flex: 1;
      min-width: 0;
      height: 100%;
    }
    .panel {
      width: 360px;
      max-width: 45vw;
      border-left: 1px solid #e5e5e5;
      background: #fff;
      overflow: auto;
      padding: 16px;
      box-sizing: border-box;
    }

    .panel h2 { margin: 0 0 8px; }
    .muted { color: #666; font-size: 14px; margin-bottom: 10px; }

    .event {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .event:hover { background: #fafafa; }
    .nameRow { display: flex; align-items: center; gap: 10px; }
    .dot {
      width: 14px; height: 14px; border-radius: 50%;
      flex: 0 0 14px;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.12);
    }
    .name { font-weight: 800; font-size: 22px; }
    .meta { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; color: #333; }

    /* ---------- Mobile: bottom sheet ---------- */
    @media (max-width: 768px) {
      .app { flex-direction: column; }
      #map { height: 100%; }

      .panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: auto;
        max-width: none;
        height: 46vh;
        border-left: none;
        border-top: 1px solid #e5e5e5;
        border-radius: 14px 14px 0 0;
        z-index: 9999; /* above Leaflet */
        box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
        padding-top: 10px;
      }
      .grab {
        width: 44px; height: 5px;
        border-radius: 999px;
        background: #ddd;
        margin: 0 auto 10px;
      }
      .panelHeaderRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 8px;
      }
      .btn {
        border: 1px solid #ddd;
        background: #fff;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 16px;
      }

      /* allow map zoom buttons not blocked too much */
      .leaflet-top.leaflet-left { top: 10px; left: 10px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="map"></div>

    <aside class="panel" id="panel">
      <div class="grab"></div>

      <div class="panelHeaderRow">
        <div>
          <h2>Events</h2>
          <div class="muted">Auto-refresh every <span id="refreshSec">3</span>s</div>
        </div>
        <button class="btn" id="toggleBtn" type="button">Hide</button>
      </div>

      <div class="muted">
        Show users active within (seconds):
        <input id="sinceSec" type="number" value="3600" style="width: 120px; padding: 6px; margin-left: 8px;">
      </div>

      <div id="status" class="muted"></div>
      <div id="events"></div>
    </aside>
  </div>

  <script>
    // --- Map init ---
    const map = L.map('map').setView([1.3521, 103.8198], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- UI state ---
    const panel = document.getElementById('panel');
    const toggleBtn = document.getElementById('toggleBtn');
    const eventsEl = document.getElementById('events');
    const statusEl = document.getElementById('status');
    const sinceInput = document.getElementById('sinceSec');

    let panelVisible = true;
    toggleBtn.addEventListener('click', () => {
      panelVisible = !panelVisible;
      panel.style.display = panelVisible ? 'block' : 'none';
      toggleBtn.textContent = panelVisible ? 'Hide' : 'Show';
      if (!panelVisible) {
        // create a small floating button to bring it back on mobile
        const btn = document.createElement('button');
        btn.id = 'showPanelBtn';
        btn.textContent = 'Events';
        btn.className = 'btn';
        btn.style.position = 'fixed';
        btn.style.right = '12px';
        btn.style.bottom = '12px';
        btn.style.zIndex = '99999';
        document.body.appendChild(btn);
        btn.onclick = () => {
          panelVisible = true;
          panel.style.display = 'block';
          toggleBtn.textContent = 'Hide';
          btn.remove();
        };
      } else {
        const btn = document.getElementById('showPanelBtn');
        if (btn) btn.remove();
      }
    });

    // --- Per-user colors + markers ---
    const userColor = new Map();
    function colorFor(name) {
      if (userColor.has(name)) return userColor.get(name);
      // stable color from name
      let hash = 0;
      for (let i = 0; i < name.length; i++) hash = ((hash << 5) - hash) + name.charCodeAt(i);
      const hue = Math.abs(hash) % 360;
      const c = `hsl(${hue} 70% 45%)`;
      userColor.set(name, c);
      return c;
    }

    const markers = new Map(); // name -> leaflet marker

    function makeDotIcon(color) {
      return L.divIcon({
        className: '',
        html: `<div style="
          width:18px;height:18px;border-radius:50%;
          background:${color};
          border:2px solid #fff;
          box-shadow:0 0 0 1px rgba(0,0,0,.25);
        "></div>`,
        iconSize: [18, 18],
        iconAnchor: [9, 9]
      });
    }

    function upsertMarker(p) {
      const name = p.user || 'unknown';
      const col = colorFor(name);
      const latlng = [p.lat, p.lng];

      if (!markers.has(name)) {
        const m = L.marker(latlng, { icon: makeDotIcon(col) }).addTo(map);
        m.bindPopup(`<b>${name}</b><br>${p.ts}`);
        markers.set(name, m);
      } else {
        const m = markers.get(name);
        m.setLatLng(latlng);
        m.setPopupContent(`<b>${name}</b><br>${p.ts}`);
      }
    }

    function focusOn(name) {
      const m = markers.get(name);
      if (!m) return;
      map.setView(m.getLatLng(), Math.max(map.getZoom(), 15), { animate: true });
      m.openPopup();
    }

    async function fetchPositions() {
      const since = Number(sinceInput.value || 3600);
      const url = `/positions?since_sec=${encodeURIComponent(since)}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    function renderEvents(list) {
      statusEl.textContent = `OK (${list.length} users)`;
      eventsEl.innerHTML = '';

      // show newest first
      list.sort((a,b) => (b.ts || '').localeCompare(a.ts || ''));

      for (const p of list) {
        const name = p.user || 'unknown';
        const col = colorFor(name);

        const row = document.createElement('div');
        row.className = 'event';
        row.innerHTML = `
          <div class="nameRow">
            <span class="dot" style="background:${col}"></span>
            <div class="name">${name}</div>
          </div>
          <div class="meta">${p.ts}</div>
          <div class="meta">lat ${p.lat}, lng ${p.lng}</div>
        `;
        row.onclick = () => focusOn(name);
        eventsEl.appendChild(row);
      }
    }

    async function refresh() {
      try {
        const data = await fetchPositions();
        // data expected: [{user, lat, lng, ts}, ...]
        data.forEach(upsertMarker);
        renderEvents(data);
      } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
      }
    }

    refresh();
    setInterval(refresh, 3000);
  </script>
</body>
</html>